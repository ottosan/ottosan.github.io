<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<title>書き初め</title>
	<style type="text/css">
		#mycanvas{
			border: 3px solid #2D3C6D;
			/*カーソル筆にしたい*/
			cursor: url('../images/hude.cur'), auto;
			/*cursor: crosshair;*/
		}
		.thumbnail{
			border: 2px solid #999;
			margin-right: 5px;
		}
	</style>
</head>
<body>
<canvas width="300" height="400" id="mycanvas">
	Canvasに対応したブラウザを用意して下さい．
</canvas>
<p>
	<select id="penWidth">
		<option value="20">太筆</option>
		<option value="10" selected>中筆</option>
		<option value="3">細筆</option>
	</select>
	<input type="button" id="erase" value="消去">
	<input type="button" id="save" value="共有">
</p>
<div id="gallery"></div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript">
	$(function(){
		var canvas = document.getElementById('mycanvas');
		if(!canvas || !canvas.getContext) return false;
		var ctx = canvas.getContext('2d');

		var startX, startY, x, y;
		var borderWidth = 3;
		var isDrawing = false;
		var penWidth = 10;

		$('#mycanvas').mousedown(function(e){
			isDrawing = true;
			startX = e.pageX - $(this).offset().left - borderWidth;
			startY = e.pageY - $(this).offset().top - borderWidth;
		})
		.mousemove(function(e){
			if(!isDrawing) return;
			x = e.pageX - $(this).offset().left - borderWidth;
			y = e.pageY - $(this).offset().top - borderWidth;
			//ctx.beginPath();
			//ctx.moveTo(startX, startY);
			//ctx.lineTo(x, y);
			//ctx.stroke();
			//ctx.arc(startX, startY, penWidth, 0, Math.PI * 2, false);
			ctx.fillRect(startX, startY, penWidth, penWidth);
			//ctx.fill();
			startX = x;
			startY = y;
		})
		.mouseup(function(){
			isDrawing = false;
		})
		.mouseleave(function(){
			isDrawing = false;
		});

		// スマホ対応
		canvas.addEventListener('touchstart', function(e){
			isDrawing = true;
			e.preventDefault(); 
			startX = e.changedTouches[0].pageX - $(this).offset().left - borderWidth;
			startY = e.changedTouches[0].pageY - $(this).offset().top - borderWidth;
		});
		canvas.addEventListener('touchmove', function(e){
			if(!isDrawing) return;
			e.preventDefault();
			x = e.changedTouches[0].pageX - $(this).offset().left - borderWidth;
			y = e.changedTouches[0].pageY - $(this).offset().top - borderWidth;
			ctx.beginPath();
			ctx.moveTo(startX, startY);
			ctx.lineTo(x, y);
			ctx.stroke();
			startX = x;
			startY = y;
		});
		canvas.addEventListener('touchend', function(){
			isDrawing = false;
		});
		canvas.addEventListener('touchcancel', function(){
			isDrawing = false;
		});

		// 太さ変更
		$("#penWidth").change(function(){
			penWidth = $(this).val();
		});
		// 消去
		$('#erase').click(function(){
			if(!confirm('本当に消去しますか？')) return;
			ctx.clearRect(0, 0, canvas.width, canvas.height);
		});
		//共有
		$('#save').click(function(){
			var img = $('<img>').attr({
				width: 150,
				height: 200, 
				src: canvas.toDataURL()
			});
			var link = $('<a>').attr({
				href: canvas.toDataURL().replace('image/png', 'application/octet-stream'),
				download: new Date().getTime()+'.png'
			})
			$('#gallery').append(link.append(img.addClass('thumbnail')));
			ctx.clearRect(0, 0, canvas.width, canvas.height);
		});
	});
</script>
</body>
</html>